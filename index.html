<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Catálogo</title><meta name=description content="Catálogo de productos con precios y stock en tiempo real."><style>html,body{margin:0;height:100%;font:500 15px/1.35 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#101114;background:#f6f7fb}*{box-sizing:border-box}img{display:block;max-width:100%}button,input,select{font:inherit}a{color:inherit;text-decoration:none}.btn{border:1px solid #101114;background:#101114;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}.ghost{background:#fff;color:#101114}.icon{font-size:18px}.wrap{max-width:1200px;margin:auto;padding:12px;display:grid;gap:12px}header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid #e6e8ef}#bar{max-width:1200px;margin:auto;padding:10px 12px;display:grid;gap:8px}#row1{display:flex;gap:8px;align-items:center;justify-content:space-between}#brand{font-weight:800;font-size:18px}#row2{display:grid;grid-template-columns:1fr;gap:8px}#controls{display:grid;grid-template-columns:1.1fr .8fr .8fr .8fr auto auto auto;gap:8px}#q{border:1px solid #d7dbeb;border-radius:10px;padding:10px 12px;background:#fff}#vista,#orden,#catQuick{border:1px solid #d7dbeb;border-radius:10px;padding:10px 12px;background:#fff}#share,#csv,#toggleFilters,#viewMode,#scrollMode,#clear{white-space:nowrap}.chips{display:flex;gap:6px;flex-wrap:wrap}chip{display:flex;align-items:center;gap:6px;background:#eef1f7;border:1px solid #dfe3ef;border-radius:999px;padding:4px 8px;font-size:12px}chip button{border:0;background:transparent;cursor:pointer}main{display:grid;grid-template-columns:1fr;gap:12px}#layout{display:grid;grid-template-columns:1fr;gap:12px}aside{border:1px solid #e6e8ef;background:#fff;border-radius:12px;padding:10px;display:grid;gap:10px}aside h3{margin:0;font-size:16px}details>summary{cursor:pointer;list-style:none}details>summary::marker{content:""}.facets{display:grid;gap:8px}.facet{display:grid;gap:6px}.facet .opt{display:flex;align-items:center;gap:6px}#priceInputs{display:flex;gap:6px}#priceInputs input{width:100%;border:1px solid #d7dbeb;border-radius:10px;padding:8px 10px;background:#fff}#metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}#metrics .card{border:1px solid #e6e8ef;background:#fff;border-radius:12px;padding:10px;display:grid;gap:4px}#grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}card{display:grid;gap:8px;border:1px solid #e6e8ef;background:#fff;border-radius:12px;padding:10px;position:relative;outline:2px solid transparent;outline-offset:0}card.sel{outline-color:#101114}card .img{width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;background:#f0f2f6}card.list{grid-template-columns:120px 1fr;gap:12px}card.list .img{aspect-ratio:auto;height:120px}card .row{display:flex;gap:6px;align-items:center;justify-content:space-between}card .name{font-weight:700}card .cat{font-size:12px;opacity:.7}card .price{font-weight:800}card .old{font-size:12px;text-decoration:line-through;opacity:.6}card .badge{position:absolute;left:10px;top:10px;background:#101114;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}card .cmp{position:absolute;right:10px;top:10px}#pg{display:flex;gap:8px;justify-content:center;align-items:center}#pg .btn{padding:8px 10px}#modal{position:fixed;inset:0;background:rgba(16,17,20,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}#modal .box{width:min(96vw,920px);max-height:92vh;overflow:auto;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:12px;display:grid;gap:10px}#modal .hd{display:flex;align-items:center;justify-content:space-between;gap:8px}#modal .bd{display:grid;grid-template-columns:1fr;gap:10px}#gal{display:grid;grid-template-columns:1fr;gap:8px}#thumbs{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:6px}#thumbs img{height:60px;object-fit:cover;border:1px solid #e6e8ef;border-radius:8px;cursor:pointer}#cmpbar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:#101114;color:#fff;border-radius:999px;padding:8px 12px;display:none;gap:8px;align-items:center;z-index:40}#cmpbar img{height:28px;width:28px;object-fit:cover;border-radius:6px;border:1px solid #fff}#empty{border:1px dashed #d7dbeb;background:#fff;border-radius:12px;padding:16px;text-align:center}#warn{color:#d33}#toast{position:fixed;right:14px;bottom:14px;z-index:60;display:grid;gap:6px;max-width:min(90vw,360px)}.toast{background:#101114;color:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 12px 40px rgba(0,0,0,.25)}@media(min-width:960px){#layout{grid-template-columns:280px 1fr}#grid{grid-template-columns:repeat(3,minmax(0,1fr))}#modal .bd{grid-template-columns:1fr 1fr}}@media(min-width:1240px){#grid{grid-template-columns:repeat(4,minmax(0,1fr))}}</style></head><body><header><div id=bar><div id=row1><div id=brand>Catálogo</div><div style=display:flex;gap:6px><select id=catQuick><option value="">Todas</option></select><button id=viewMode class=btn>Vista: Grilla</button><button id=scrollMode class="btn ghost">Modo scroll</button><button id=share class=btn>Compartir</button><button id=csv class="btn ghost">Exportar CSV</button></div></div><div id=row2><div id=controls><input id=q placeholder=Buscar... autocomplete=off><select id=vista><option value=todos>Todos</option><option value=destacados>Destacados</option><option value=ofertas>Ofertas</option><option value=nuevos>Nuevos</option><option value=bajos>Últimas unidades</option></select><select id=orden><option value=rel>Relevancia</option><option value=pa>Precio ↑</option><option value=pd>Precio ↓</option><option value=sa>Stock ↑</option><option value=sd>Stock ↓</option><option value=fa>Fecha ↑</option><option value=fd>Fecha ↓</option><option value=dd>Descuento ↓</option></select><button id=toggleFilters class="btn ghost">Filtros</button><button id=clear class="btn ghost">Limpiar</button><select id=per><option value=24>24</option><option value=48>48</option><option value=96>96</option></select></div><div class=chips id=chips></div></div></div></header><div class=wrap><div id=layout><aside id=filters><h3>Filtros</h3><details open><summary>Categorías</summary><div id=facetCat class=facets></div></details><details open><summary>Precio</summary><div class=facet><div id=priceInputs><input id=pmin type=number inputmode=decimal min=0 step=.01 placeholder=Mín><input id=pmax type=number inputmode=decimal min=0 step=.01 placeholder=Máx></div><input id=slmin type=range min=0 max=0 step=.01><input id=slmax type=range min=0 max=0 step=.01></div></details><details open><summary>Stock</summary><div class=facet><label class=opt><input type=radio name=st id=st0 value="" checked>Todos</label><label class=opt><input type=radio name=st id=st1 value=in>En stock</label><label class=opt><input type=radio name=st id=st2 value=low>Últimas unidades</label><label class=opt><input type=radio name=st id=st3 value=out>Agotados</label><div style=display:flex;gap:6px;align-items:center><span>Umbral</span><input id=sth type=number min=1 max=99 step=1 value=5 style="width:80px;border:1px solid #d7dbeb;border-radius:10px;padding:6px 8px"></div></div></details><details><summary>Estado</summary><div class=facet><label class=opt><input type=checkbox id=incInact>Incluir inactivos</label></div></details></aside><main><div id=metrics><div class=card><div style=opacity:.7>Mostrados/Total</div><div id=mCount>—</div></div><div class=card><div style=opacity:.7>Stock total mostrado</div><div id=mStock>—</div></div><div class=card><div style=opacity:.7>Rango de precios</div><div id=mRange>—</div></div></div><div id=empty style=display:none><div id=emptyMsg>Catálogo vacío</div></div><div id=grid></div><div id=pg><button id=prev class="btn ghost">◀</button><div id=pginfo>—</div><button id=next class="btn ghost">▶</button></div></main></div></div><div id=cmpbar><div id=cmpImgs style=display:flex;gap:6px></div><button id=cmpOpen class="btn ghost">Comparar</button></div><div id=modal role=dialog aria-modal=true aria-labelledby=mtitle><div class=box><div class=hd><div id=mtitle style=font-weight:800></div><button id=mclose class=btn>✕</button></div><div class=bd><div id=gal><img id=mainImg alt=""><div id=thumbs></div></div><div id=mdetail style=display:grid;gap:8px><div id=mprice style=font-weight:800;font-size:18px></div><div id=mbadges style=display:flex;gap:6px;flex-wrap:wrap></div><div id=mdesc></div><div style=display:grid;gap:6px><div style=opacity:.7>Datos</div><div id=minfo style=display:grid;gap:4px></div><div style=display:flex;gap:6px;flex-wrap:wrap><button id=shareItem class="btn ghost">Compartir</button></div></div></div></div></div><div id=toast></div><script type=application/ld+json id=ld>{}</script><script>const $=q=>document.querySelector(q),$$=q=>Array.from(document.querySelectorAll(q));const money=v=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(+v||0);const fmtDate=s=>{const d=new Date(s);return(`${d.getDate()}`.padStart(2,'0'))+'/'+(`${d.getMonth()+1}`.padStart(2,'0'))+'/'+d.getFullYear()};const QS=new URLSearchParams(location.search);const PLACE="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23e9ecf3'/%3E%3C/svg%3E";const PREFK='pub_prefs';let PREF={};try{PREF=JSON.parse(localStorage.getItem(PREFK)||'{}')}catch{PREF={}}let ALL=[],MOV=[],IDX={byId:new Map(),byCat:new Map()},VIEW='todos',SORT='rel',PAGE=+QS.get('page')||1,PER=+QS.get('per')||PREF.per||24,SEARCH=QS.get('q')||'',CAT=QS.get('cat')||'',TH=PREF.th||5,SCROLL=PREF.scroll||false,VIEWMODE=PREF.view||'grid',PSTATE={pmin:QS.get('pmin'),pmax:QS.get('pmax'),stock:QS.get('stock')||'',inact:QS.get('inact')==='1'};let INFINITE_LOADED=0,DEB=null,FOCUS=0,SEL=new Set();function toast(t){const el=document.createElement('div');el.className='toast';el.textContent=t;$('#toast').appendChild(el);setTimeout(()=>{el.style.opacity=.0;setTimeout(()=>el.remove(),230)},1500)}function setTitle(){const b=QS.get('brand')||'Catálogo';document.title=b;$('#brand').textContent=b}async function load(){const src=QS.get('src');if(src){try{const r=await fetch(src);const j=await r.json();applyData(j);if(ALL.length)return}catch{}}try{const la=JSON.parse(localStorage.getItem('adm_articulos')||'[]');const lm=JSON.parse(localStorage.getItem('adm_movimientos')||'[]');applyData({articulos:la,movimientos:lm});if(ALL.length)return}catch{}try{const r=await fetch('catalogo.json');if(r.ok){const j=await r.json();applyData(j);if(ALL.length)return}}catch{}if(!ALL.length){$('#empty').style.display='block'}buildUI()}function normArt(a){const imgs=Array.isArray(a.imagenes)?a.imagenes:(a.imagen?[{src:a.imagen,type:'url',primary:true}]:[]);const img=imgs.find(i=>i.primary)||imgs[0]||null;return{id:a.id||a.sku||a.slug||crypto.randomUUID(),nombre:a.nombre||'',categoria:a.categoria||'',precio_venta:+(+a.precio_venta||0).toFixed(2),precio_oferta:a.precio_oferta!=null?+(+a.precio_oferta).toFixed(2):null,costo:a.costo!=null?+(+a.costo).toFixed(2):null,stock_actual:Math.max(0,parseInt(a.stock_actual||0)),descripcion_corta:a.descripcion_corta||'',slug:a.slug||slugify(a.nombre||''),imagenes:imgs,imagen_principal:img?img.src:PLACE,activo:a.activo!==false,creado_en:a.creado_en||a.fecha_creacion||new Date().toISOString(),destacado:a.destacado===true||a.tags?.includes?.('destacado')||false}}function applyData(j){let arr=[],mov=[];if(Array.isArray(j))arr=j;else if(j.articulos)arr=j.articulos;else if(j.items)arr=j.items;ALL=arr.map(normArt);if(j.movimientos)mov=j.movimientos;else if(Array.isArray(j)&&j.some(x=>x.tipo))mov=j.filter(x=>x.tipo);try{const lm=JSON.parse(localStorage.getItem('adm_movimientos')||'[]');if(!mov.length&&lm.length)mov=lm}catch{}MOV=mov.map(m=>({tipo:m.tipo,art:m.art||m.articulo||m.articulo_id||m.id,art_nombre:m.art_nombre||'',cantidad:Math.max(0,parseInt(m.cantidad||0)),precio_unitario:+(+m.precio_unitario||0).toFixed(2),fecha:m.fecha||m.creado_en||new Date().toISOString()}));indexData()}function indexData(){IDX.byId.clear();IDX.byCat.clear();ALL.forEach(a=>{IDX.byId.set(a.id,a);const c=a.categoria||'Sin categoría';if(!IDX.byCat.has(c))IDX.byCat.set(c,[]);IDX.byCat.get(c).push(a)})}function slugify(s){return (s||'').normalize('NFD').replace(/[̀-ͯ]/g,'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}function setParams(obj){Object.entries(obj).forEach(([k,v])=>{if(v==null||v==='')QS.delete(k);else QS.set(k,v)});history.replaceState(null,'','?'+QS.toString())}function savePref(){localStorage.setItem(PREFK,JSON.stringify({per:PER,th:TH,scroll:SCROLL,view:VIEWMODE}))}function buildUI(){setTitle();$('#q').value=SEARCH;$('#vista').value=QS.get('vista')||'todos';$('#orden').value=QS.get('orden')||'rel';$('#per').value=PER;$('#sth').value=TH;$('#scrollMode').className=SCROLL?'btn':'btn ghost';$('#scrollMode').textContent=SCROLL?'Scroll: On':'Modo scroll';$('#viewMode').textContent=VIEWMODE==='grid'?'Vista: Grilla':'Vista: Lista';if(PSTATE.pmin!=null)$('#pmin').value=PSTATE.pmin;if(PSTATE.pmax!=null)$('#pmax').value=PSTATE.pmax;if(PSTATE.stock)$$('input[name=st]').find(x=>x.value===PSTATE.stock).checked=true;$('#incInact').checked=PSTATE.inact;buildCats();syncPriceSliders();buildQuickCats();render();bindKeys();applyHashOpen()}function buildQuickCats(){const sel=$('#catQuick');sel.innerHTML='<option value="">Todas</option>'+[...IDX.byCat.keys()].sort().map(c=>`<option>${c}</option>`).join('');sel.value=CAT;sel.onchange=()=>{CAT=sel.value;setParams({cat:CAT,page:1});PAGE=1;render()}}function buildCats(){const f=$('#facetCat');const cats=[...new Set(ALL.map(a=>a.categoria||'Sin categoría'))].sort();f.innerHTML='';cats.forEach(c=>{const n=document.createElement('label');n.className='opt';const i=document.createElement('input');i.type='radio';i.name='cat';i.value=c;i.checked=c===CAT;const t=document.createElement('span');const cnt=ALL.filter(a=>(a.categoria||'Sin categoría')===c).length;t.textContent=`${c} (${cnt})`;n.append(i,t);i.onchange=()=>{CAT=i.checked?i.value:'';setParams({cat:CAT,page:1});PAGE=1;$('#catQuick').value=CAT;render()};f.append(n)});const any=document.createElement('label');any.className='opt';const r=document.createElement('input');r.type='radio';r.name='cat';r.value='';r.checked=!CAT;const s=document.createElement('span');s.textContent='Todas';any.append(r,s);r.onchange=()=>{CAT='';setParams({cat:'',page:1});PAGE=1;$('#catQuick').value='';render()};f.prepend(any)}function syncPriceSliders(){const prices=ALL.map(a=>a.precio_venta).filter(x=>x>0);const min=prices.length?Math.min(...prices):0;const max=prices.length?Math.max(...prices):0;const smin=$('#slmin'),smax=$('#slmax');smin.min=0;smax.min=0;smin.max=max;smax.max=max;smin.value=PSTATE.pmin||0;smax.value=PSTATE.pmax||max;$('#pmin').placeholder=money(min);$('#pmax').placeholder=money(max);if(PSTATE.pmin!=null&&PSTATE.pmin!=='')$('#pmin').value=PSTATE.pmin;if(PSTATE.pmax!=null&&PSTATE.pmax!=='')$('#pmax').value=PSTATE.pmax;smin.oninput=()=>{$('#pmin').value=smin.value;PSTATE.pmin=smin.value;setParams({pmin:PSTATE.pmin,page:1});PAGE=1;resetInfinite();render()};smax.oninput=()=>{$('#pmax').value=smax.value;PSTATE.pmax=smax.value;setParams({pmax:PSTATE.pmax,page:1});PAGE=1;resetInfinite();render()};$('#pmin').onblur=()=>{PSTATE.pmin=$('#pmin').value;setParams({pmin:PSTATE.pmin,page:1});PAGE=1;resetInfinite();render()};$('#pmax').onblur=()=>{PSTATE.pmax=$('#pmax').value;setParams({pmax:PSTATE.pmax,page:1});PAGE=1;resetInfinite();render()}}function getView(){const v=$('#vista').value;VIEW=v;return v}function getSort(){const s=$('#orden').value;SORT=s;return s}function applyFilters(){const q=SEARCH.toLowerCase().trim();const v=getView();const s=getSort();const pmin=+($('#pmin').value||0),pmax=+($('#pmax').value||Number.MAX_SAFE_INTEGER);const st=$$('input[name=st]').find(x=>x.checked).value;const inc=$('#incInact').checked;let arr=ALL.slice();if(!inc)arr=arr.filter(a=>a.activo);if(q)arr=arr.filter(a=>a.nombre.toLowerCase().includes(q)||a.descripcion_corta.toLowerCase().includes(q)||a.slug.toLowerCase().includes(q)||a.categoria.toLowerCase().includes(q));if(CAT)arr=arr.filter(a=>(a.categoria||'Sin categoría')===CAT);arr=arr.filter(a=>a.precio_venta>=pmin&&a.precio_venta<=pmax);if(st==='in')arr=arr.filter(a=>a.stock_actual>0);if(st==='low')arr=arr.filter(a=>a.stock_actual>0&&a.stock_actual<=TH);if(st==='out')arr=arr.filter(a=>a.stock_actual<=0);if(v==='destacados')arr=arr.filter(a=>a.destacado);if(v==='ofertas')arr=arr.filter(a=>a.precio_oferta!=null&&a.precio_oferta>=0);if(v==='nuevos')arr=arr.slice().sort((a,b)=>new Date(b.creado_en)-new Date(a.creado_en));if(v==='bajos')arr=arr.filter(a=>a.stock_actual>0&&a.stock_actual<=TH);if(v==='mas'){const rank=salesRank();arr=arr.filter(a=>rank.has(a.id)).sort((a,b)=>rank.get(b.id)-rank.get(a.id))}if(s==='pa')arr.sort((a,b)=>a.precio_venta-b.precio_venta);if(s==='pd')arr.sort((a,b)=>b.precio_venta-a.precio_venta);if(s==='sa')arr.sort((a,b)=>a.stock_actual-b.stock_actual);if(s==='sd')arr.sort((a,b)=>b.stock_actual-a.stock_actual);if(s==='fa')arr.sort((a,b)=>new Date(a.creado_en)-new Date(b.creado_en));if(s==='fd')arr.sort((a,b)=>new Date(b.creado_en)-new Date(a.creado_en));if(s==='dd')arr.sort((a,b)=>(b.precio_venta-(b.precio_oferta??b.precio_venta))-(a.precio_venta-(a.precio_oferta??a.precio_venta)));if(s==='rel'&&q)arr.sort((a,b)=>score(b,q)-score(a,q));return arr}function score(a,q){let s=0;const n=a.nombre.toLowerCase();const d=a.descripcion_corta.toLowerCase();const c=a.categoria.toLowerCase();if(n.startsWith(q))s+=3;if(n.includes(q))s+=2;if(d.includes(q))s+=1;if(c.includes(q))s+=.5;return s}function salesRank(){const m=new Map();MOV.filter(x=>x.tipo==='venta').forEach(x=>{const id=x.art;const cur=m.get(id)||0;m.set(id,cur+Math.max(0,parseInt(x.cantidad||0)))}) ;return m}function render(){const arr=applyFilters();const total=ALL.length;renderChips();renderMetrics(arr);const pages=Math.max(1,Math.ceil(arr.length/PER));if(SCROLL){$('#pg').style.display='none';if(INFINITE_LOADED===0)$('#grid').innerHTML='';const end=Math.min(arr.length,INFINITE_LOADED+PER);renderGrid(arr.slice(INFINITE_LOADED,end),true);INFINITE_LOADED=end;window.onscroll=()=>{if((window.innerHeight+window.scrollY)>=document.body.offsetHeight-200){if(INFINITE_LOADED<arr.length){const next=Math.min(arr.length,INFINITE_LOADED+PER);renderGrid(arr.slice(INFINITE_LOADED,next),true);INFINITE_LOADED=next}}};$('#pginfo').textContent=`${Math.ceil(INFINITE_LOADED/PER)}/${pages}`}else{window.onscroll=null;INFINITE_LOADED=0;const start=(PAGE-1)*PER;renderGrid(arr.slice(start,start+PER),false);renderPager(arr.length)}renderLd(arr.slice(0,Math.min(arr.length,30)));const hasMov=MOV.some(x=>x.tipo==='venta');if(hasMov&&!Array.from($('#vista').options).some(o=>o.value==='mas')){const o=document.createElement('option');o.value='mas';o.textContent='Más vendidos';$('#vista').append(o)}$('#empty').style.display=arr.length? 'none':'block'}function renderChips(){const c=$('#chips');c.innerHTML='';const add=(k,disp,clr)=>{const ch=document.createElement('chip');ch.textContent=disp+' ';const b=document.createElement('button');b.textContent='×';b.onclick=clr;ch.append(b);c.append(ch)};if(SEARCH)add('q','Búsqueda: '+SEARCH,()=>{$('#q').value='';SEARCH='';setParams({q:'' ,page:1});PAGE=1;resetInfinite();render()});if(CAT)add('cat','Categoría: '+CAT,()=>{CAT='';setParams({cat:'',page:1});$('#catQuick').value='';PAGE=1;resetInfinite();render()});if($('#pmin').value)add('pmin','Mín: '+money($('#pmin').value),()=>{$('#pmin').value='';PSTATE.pmin='';setParams({pmin:'' ,page:1});PAGE=1;resetInfinite();render()});if($('#pmax').value)add('pmax','Máx: '+money($('#pmax').value),()=>{$('#pmax').value='';PSTATE.pmax='';setParams({pmax:'' ,page:1});PAGE=1;resetInfinite();render()});const stVal=$$('input[name=st]').find(x=>x.checked).value;if(stVal==='in')add('st','En stock',()=>{$('#st0').checked=true;PSTATE.stock='';setParams({stock:'' ,page:1});PAGE=1;resetInfinite();render()});if(stVal==='low')add('st','Últimas (≤'+TH+')',()=>{$('#st0').checked=true;PSTATE.stock='';setParams({stock:'' ,page:1});PAGE=1;resetInfinite();render()});if(stVal==='out')add('st','Agotados',()=>{$('#st0').checked=true;PSTATE.stock='';setParams({stock:'' ,page:1});PAGE=1;resetInfinite();render()});if($('#incInact').checked)add('inact','Incluye inactivos',()=>{$('#incInact').checked=false;setParams({inact:'' ,page:1});PAGE=1;resetInfinite();render()})}function resetInfinite(){if(SCROLL){INFINITE_LOADED=0;$('#grid').innerHTML=''}}function renderMetrics(arr){$('#mCount').textContent=`${arr.length}/${ALL.length}`;const st=arr.reduce((s,a)=>s+(a.stock_actual||0),0);$('#mStock').textContent=String(st);const prices=arr.map(a=>a.precio_venta).filter(x=>x>0);$('#mRange').textContent=prices.length?`${money(Math.min(...prices))}–${money(Math.max(...prices))}`:'—'}function cardEl(a){const el=document.createElement('card');if(VIEWMODE==='list')el.classList.add('list');const imgBox=document.createElement('div');imgBox.className='img';const im=document.createElement('img');im.loading='lazy';im.decoding='async';im.src=a.imagen_principal||PLACE;im.alt=a.nombre;im.onerror=()=>im.src=PLACE;imgBox.append(im);const name=document.createElement('div');name.className='name';name.textContent=a.nombre;const cat=document.createElement('div');cat.className='cat';cat.textContent=a.categoria;const row=document.createElement('div');row.className='row';const price=document.createElement('div');price.className='price';const p=a.precio_oferta!=null&&a.precio_oferta>=0;price.textContent=p?money(a.precio_oferta):money(a.precio_venta);const old=document.createElement('div');old.className='old';if(p)old.textContent=money(a.precio_venta);row.append(price,old);const btn=document.createElement('button');btn.className='btn';btn.textContent='Ver';btn.onclick=()=>openModal(a);const badge=document.createElement('div');badge.className='badge';badge.textContent=a.stock_actual>0?(a.stock_actual<=TH?`Quedan ${a.stock_actual}`:'En stock'):'Agotado';const cmp=document.createElement('input');cmp.type='checkbox';cmp.className='cmp';cmp.title='Comparar';cmp.checked=SEL.has(a.id);cmp.onchange=()=>toggleSel(a);el.append(imgBox,name,cat,row,btn,badge,cmp);return el}function renderGrid(items,append){const g=$('#grid');if(!append)g.innerHTML='';items.forEach(a=>g.append(cardEl(a)));g.onclick=e=>{if(e.target.closest('card button'))return;if(e.target.closest('card')){const i=$$('#grid card').indexOf(e.target.closest('card'));const id=$$('#grid card')[i]?.querySelector('.cmp')?IDX.byId.get(items[i]?.id)?.id:null;openModal(items[i]||IDX.byId.get(id))}};updateCmpbar();applyFocus()}function renderPager(n){const pages=Math.max(1,Math.ceil(n/PER));$('#pg').style.display='flex';$('#pginfo').textContent=`${PAGE}/${pages}`;$('#prev').disabled=PAGE<=1;$('#next').disabled=PAGE>=pages;$('#prev').onclick=()=>{if(PAGE>1){PAGE--;setParams({page:PAGE});render();scrollToTop()}};$('#next').onclick=()=>{if(PAGE<pages){PAGE++;setParams({page:PAGE});render();scrollToTop()}}}function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'})}function openModal(a){if(!a)return;$('#modal').style.display='grid';$('#mtitle').textContent=a.nombre;$('#mdesc').textContent=a.descripcion_corta||'';$('#minfo').innerHTML='';addInfo('Categoría',a.categoria);addInfo('Precio',money(a.precio_venta));if(a.precio_oferta!=null)addInfo('Oferta',money(a.precio_oferta));addInfo('Stock',a.stock_actual);addInfo('Estado',a.activo?'Activo':'Inactivo');addInfo('Creación',fmtDate(a.creado_en));$('#mprice').textContent=a.precio_oferta!=null?money(a.precio_oferta):money(a.precio_venta);const badges=$('#mbadges');badges.innerHTML='';if(a.stock_actual<=TH)badges.append(tag('Últimas unidades'));if(a.precio_oferta!=null)badges.append(tag('Oferta'));const gal=a.imagenes&&a.imagenes.length?a.imagenes:[{src:a.imagen_principal||PLACE}];const main=$('#mainImg');main.src=gal[0].src||PLACE;main.alt=a.nombre;main.onerror=()=>main.src=PLACE;$('#thumbs').innerHTML='';gal.forEach((im,i)=>{const t=document.createElement('img');t.src=im.src;t.alt=a.nombre+' '+(i+1);t.loading='lazy';t.decoding='async';t.onerror=()=>t.src=PLACE;t.onclick=()=>{main.src=im.src};$('#thumbs').append(t)});$('#mclose').onclick=closeModal;$('#modal').onclick=e=>{if(e.target.id==='modal')closeModal()};$('#shareItem').onclick=()=>shareLink('#'+a.slug)}function addInfo(k,v){const d=document.createElement('div');d.textContent=k+': '+v;$('#minfo').append(d)}function tag(t){const s=document.createElement('span');s.style.cssText='background:#eef1f7;border:1px solid #dfe3ef;border-radius:999px;padding:4px 8px;font-size:12px';s.textContent=t;return s}function closeModal(){$('#modal').style.display='none'}function toggleSel(a){if(SEL.has(a.id))SEL.delete(a.id);else{if(SEL.size>=3){toast('Máximo 3');return}SEL.add(a.id)}updateCmpbar()}function updateCmpbar(){const bar=$('#cmpbar');if(!SEL.size){bar.style.display='none';return}bar.style.display='flex';const imgs=$('#cmpImgs');imgs.innerHTML='';[...SEL].map(id=>IDX.byId.get(id)).forEach(a=>{const i=document.createElement('img');i.src=a.imagen_principal||PLACE;i.alt=a.nombre;i.onerror=()=>i.src=PLACE;imgs.append(i)});$('#cmpOpen').onclick=()=>openCompare()}function openCompare(){const list=[...SEL].map(id=>IDX.byId.get(id)).filter(Boolean);const box=$('#mdetail');$('#modal').style.display='grid';$('#mtitle').textContent='Comparación';$('#mprice').textContent='';$('#mdesc').textContent='';$('#mbadges').innerHTML='';$('#minfo').innerHTML='';const tbl=document.createElement('table');tbl.style.width='100%';tbl.style.borderCollapse='collapse';const head=['','Nombre','Categoría','Precio','Stock'];const trh=document.createElement('tr');head.forEach(h=>{const th=document.createElement('th');th.textContent=h;th.style.border='1px solid #eee';th.style.padding='6px';trh.appendChild(th)});tbl.appendChild(trh);list.forEach(a=>{const tr=document.createElement('tr');[a.imagen_principal,a.nombre,a.categoria,money(a.precio_oferta??a.precio_venta),a.stock_actual].forEach((val,idx)=>{const td=document.createElement('td');td.style.border='1px solid #eee';td.style.padding='6px';if(idx===0){const i=document.createElement('img');i.src=val||PLACE;i.alt=a.nombre;i.style.height='42px';i.style.objectFit='cover';i.onerror=()=>i.src=PLACE;td.append(i)}else td.textContent=val;tr.append(td)});tbl.append(tr)});box.innerHTML='';box.append(tbl)}function renderLd(items){const graph=items.map(a=>({"@type":"Product",name:a.nombre,description:a.descripcion_corta,image:a.imagen_principal,sku:a.slug,category:a.categoria,offers:{"@type":"Offer",priceCurrency:"ARS",price:(a.precio_oferta??a.precio_venta),availability:(a.stock_actual>0?"https://schema.org/InStock":"https://schema.org/OutOfStock")}}));const ld={"@context":"https://schema.org","@graph":graph};$('#ld').textContent=JSON.stringify(ld)}$('#q').oninput=e=>{clearTimeout(DEB);DEB=setTimeout(()=>{SEARCH=e.target.value;PAGE=1;setParams({q:SEARCH,page:1});resetInfinite();render()},250)};$('#vista').onchange=()=>{PAGE=1;setParams({vista:getView(),page:1});resetInfinite();render()};$('#orden').onchange=()=>{PAGE=1;setParams({orden:getSort(),page:1});resetInfinite();render()};$('#per').onchange=()=>{PER=+$('#per').value;PAGE=1;setParams({per:PER,page:1});savePref();resetInfinite();render()};$('#sth').onchange=()=>{TH=Math.max(1,Math.floor(+$('#sth').value||5));savePref();resetInfinite();render()};$('#clear').onclick=()=>{SEARCH='';CAT='';PSTATE={pmin:'',pmax:'',stock:'',inact:false};PAGE=1;setParams({q:'',cat:'',pmin:'',pmax:'',stock:'',inact:'',page:1});buildUI()};$$('input[name=st]').forEach(r=>r.onchange=()=>{PSTATE.stock=r.value;PAGE=1;setParams({stock:r.value,page:1});resetInfinite();render()});$('#incInact').onchange=()=>{PSTATE.inact=$('#incInact').checked;PAGE=1;setParams({inact:PSTATE.inact?1:'' ,page:1});resetInfinite();render()};$('#toggleFilters').onclick=()=>{const as=$('#filters');as.style.display=as.style.display==='none'?'grid':'none'};$('#viewMode').onclick=()=>{VIEWMODE=VIEWMODE==='grid'?'list':'grid';savePref();render()};$('#scrollMode').onclick=()=>{SCROLL=!SCROLL;savePref();buildUI()};$('#share').onclick=()=>shareLink('');$('#csv').onclick=()=>{const arr=applyFilters();const items=SCROLL?arr.slice(0,INFINITE_LOADED):arr.slice((PAGE-1)*PER,(PAGE-1)*PER+PER);const rows=[["id","nombre","categoria","precio","precio_oferta","stock","slug","activo","imagen"],...items.map(a=>[a.id,a.nombre,a.categoria,a.precio_venta,a.precio_oferta??'',a.stock_actual,a.slug,a.activo?1:0,a.imagen_principal||''])];downloadCSV(rows,'catalogo.csv')};function shareLink(hash){const url=location.origin+location.pathname+'?'+QS.toString()+hash;if(navigator.share){navigator.share({title:document.title,text:'Catálogo',url}).catch(()=>copy(url))}else copy(url)}function copy(t){navigator.clipboard.writeText(t).then(()=>toast('Enlace copiado'))}function downloadCSV(rows,name){const esc=s=>`"${String(s??'').replace(/"/g,'""')}"`;const csv=rows.map(r=>r.map(esc).join(',')).join('
');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click()}function bindKeys(){document.addEventListener('keydown',e=>{if($('#modal').style.display==='grid'){if(e.key==='Escape')closeModal();return}const cards=$$('#grid card');if(!cards.length)return;if(['ArrowRight','ArrowLeft','ArrowDown','ArrowUp'].includes(e.key)){e.preventDefault();const cols=parseInt(getComputedStyle($('#grid')).gridTemplateColumns.split(' ').length)||2;let step=(e.key==='ArrowRight'?1:e.key==='ArrowLeft'?-1:e.key==='ArrowDown'?cols:-cols);FOCUS=Math.max(0,Math.min(cards.length-1,FOCUS+step));cards.forEach(c=>c.classList.remove('sel'));cards[FOCUS].classList.add('sel');cards[FOCUS].scrollIntoView({block:'nearest'})}if(e.key==='Enter'){e.preventDefault();const cards2=$$('#grid card');if(cards2[FOCUS]){const id=applyFilters()[(SCROLL?FOCUS:FOCUS+((PAGE-1)*PER))]?.id;openModal(IDX.byId.get(id)||applyFilters()[FOCUS])}}})}function applyFocus(){const cards=$$('#grid card');cards.forEach(c=>c.classList.remove('sel'));if(cards[FOCUS])cards[FOCUS].classList.add('sel')}function applyHashOpen(){const h=location.hash.slice(1);if(!h)return;const a=ALL.find(x=>x.slug===h);if(a)openModal(a)}load();</script></body></html>
