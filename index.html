<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Tienda</title>
<meta name="description" content="Tienda con carrito y WhatsApp. CSV/JSON opcional.">
<style>
html,body{margin:0;height:100%;font:500 15px/1.35 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#101114;background:#f7f8fc}*{box-sizing:border-box}img{display:block;max-width:100%}a{color:inherit;text-decoration:none}button,input,select{font:inherit}.btn{border:1px solid #101114;background:#101114;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}.ghost{background:#fff;color:#101114}.wrap{max-width:1200px;margin:auto;padding:14px;display:grid;gap:14px}header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e6e8ef}#bar{max-width:1200px;margin:auto;padding:10px 14px;display:grid;gap:10px}#row1{display:flex;gap:10px;align-items:center;justify-content:space-between}#brand{font-weight:900;font-size:18px}#row1 .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}#controls{display:grid;grid-template-columns:1fr .8fr .8fr auto auto;gap:10px}#q,#catQuick,#orden{border:1px solid #d7dbeb;border-radius:12px;padding:10px 12px;background:#fff}#grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}card{position:relative;display:grid;gap:10px;border:1px solid #e6e8ef;background:#fff;border-radius:14px;padding:10px;overflow:hidden;transition:transform .2s ease,box-shadow .2s ease}card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(16,17,20,.08)}.img{border-radius:12px;overflow:hidden;background:#eef1f7}.img img{width:100%;aspect-ratio:1/1;object-fit:cover}.name{font-weight:800;line-height:1.2}.cat{font-size:12px;opacity:.7}.row{display:flex;align-items:center;justify-content:space-between}.price{font-weight:900}.old{font-size:12px;text-decoration:line-through;opacity:.6}.badge{position:absolute;left:10px;top:10px;background:#101114;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px}.actions{display:flex;gap:8px;flex-wrap:wrap}#count{opacity:.7}#pg{display:flex;gap:10px;justify-content:center;align-items:center}#pg .btn{padding:8px 10px}#empty{border:1px dashed #d7dbeb;background:#fff;border-radius:14px;padding:18px;text-align:center}.badgeCount{background:#fff;color:#101114;border-radius:999px;padding:2px 6px;margin-left:6px;font-size:12px;border:1px solid #dfe3ef}#modal{position:fixed;inset:0;background:rgba(16,17,20,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}#modal .box{width:min(96vw,900px);max-height:92vh;overflow:auto;background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:14px;display:grid;gap:12px}#modal .hd{display:flex;align-items:center;justify-content:space-between}#modal .bd{display:grid;grid-template-columns:1fr;gap:12px}#gal{display:grid;gap:8px}#thumbs{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:6px}#thumbs img{height:60px;object-fit:cover;border:1px solid #e6e8ef;border-radius:10px;cursor:pointer}#cart{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:stretch;justify-content:flex-end;z-index:70}#cart .panel{width:min(96vw,420px);height:100vh;background:#fff;border-left:1px solid #e6e8ef;padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}#cartItems{display:grid;gap:8px;overflow:auto}.cart-row{display:grid;grid-template-columns:64px 1fr auto;gap:8px;align-items:center}.cart-row img{height:64px;width:64px;object-fit:cover;border-radius:8px;border:1px solid #e6e8ef}.input{border:1px solid #d7dbeb;border-radius:12px;padding:8px 10px;background:#fff}@media(min-width:960px){#grid{grid-template-columns:repeat(3,minmax(0,1fr))}}@media(min-width:1240px){#grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
</style>
</head>
<body>
<header>
<div id="bar">
<div id="row1">
<div id="brand">Tienda</div>
<div class="right">
<select id="catQuick"><option value="">Todas</option></select>
<select id="orden"><option value="rel">Relevancia</option><option value="pa">Precio ↑</option><option value="pd">Precio ↓</option><option value="fd">Más nuevos</option></select>
<button id="import" class="btn ghost">Importar CSV/JSON</button>
<input id="fileInput" type="file" accept=".csv,.json,application/json,text/csv" hidden>
<button id="share" class="btn ghost">Compartir</button>
<button id="cartBtn" class="btn">Carrito <span id="cartCount" class="badgeCount">0</span></button>
</div>
</div>
<div id="controls">
<input id="q" placeholder="Buscar productos..." autocomplete="off">
<div style="display:flex;gap:8px;align-items:center"><span id="count">—</span></div>
<div style="justify-self:end;display:flex;gap:8px"><button id="clear" class="btn ghost">Limpiar</button><select id="per"><option value="24">24</option><option value="48">48</option><option value="96">96</option></select></div>
</div>
</div>
</header>
<div class="wrap">
<div id="empty" style="display:none"><div>Catálogo vacío</div><div style="margin-top:10px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap"><button id="btnDemo" class="btn ghost">Cargar demo</button><button id="btnImport2" class="btn">Importar CSV/JSON</button></div></div>
<div id="grid"></div>
<div id="pg"><button id="prev" class="btn ghost">◀</button><div id="pginfo">—</div><button id="next" class="btn ghost">▶</button></div>
</div>
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="mtitle"><div class="box"><div class="hd"><div id="mtitle" style="font-weight:900"></div><button id="mclose" class="btn">✕</button></div><div class="bd"><div id="gal"><img id="mainImg" alt=""><div id="thumbs"></div></div><div id="mdetail" style="display:grid;gap:8px"><div id="mprice" style="font-weight:900;font-size:18px"></div><div id="mbadges" style="display:flex;gap:6px;flex-wrap:wrap"></div><div id="mdesc"></div><div id="minfo" style="display:grid;gap:4px"></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button id="shareItem" class="btn ghost">Compartir</button><button id="addFromModal" class="btn">Agregar al carrito</button></div></div></div></div></div>
<div id="cart"><div class="panel"><div class="hd" style="display:flex;align-items:center;justify-content:space-between;gap:8px"><h3 style="margin:0">Tu carrito</h3><button id="cartClose" class="btn">✕</button></div><div class="bd" style="display:grid;gap:10px"><div id="cartItems"></div><div style="display:grid;gap:8px"><label>Envío<select id="shipSel" class="input"></select></label><div style="display:grid;grid-template-columns:1fr auto;gap:6px"><div>Subtotal</div><div id="cartSubtotal"></div><div>Envío</div><div id="cartShipping"></div><div style="font-weight:800">Total</div><div id="cartTotal" style="font-weight:800"></div></div><label>WhatsApp destino<input id="waPhone" class="input" placeholder="54911..."></label></div></div><div class="ft" style="display:flex;gap:8px;justify-content:space-between"><button id="clearCart" class="btn ghost">Vaciar</button><button id="checkoutBtn" class="btn">Finalizar compra</button></div></div></div>
<script>
const $=q=>document.querySelector(q),$$=q=>Array.from(document.querySelectorAll(q));const money=v=>new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(+v||0);const fmtDate=s=>{const d=new Date(s);return(`${d.getDate()}`.padStart(2,'0'))+'/'+(`${d.getMonth()+1}`.padStart(2,'0'))+'/'+d.getFullYear()};const QS=new URLSearchParams(location.search);const PLACE="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23e9ecf3'/%3E%3C/svg%3E";let ALL=[],IDX={byId:new Map(),byCat:new Map()};let PAGE=+QS.get('page')||1,PER=+QS.get('per')||24,SEARCH=QS.get('q')||'',CAT=QS.get('cat')||'';const PHONE_DEFAULT=QS.get('wa')||'';const FREE=+(QS.get('free')||0);const SHIP=[{id:'ret',name:'Retiro en tienda',price:0},{id:'moto',name:'Moto CABA/GBA',price:+(QS.get('moto')||2500)},{id:'correo',name:'Correo Argentino',price:+(QS.get('correo')||4500)}];let CART=[],SHIPID=localStorage.getItem('pub_ship')||'ret',WAPHONE=localStorage.getItem('wa_phone')||PHONE_DEFAULT||'';function setTitle(){const b=QS.get('brand')||'Tienda';document.title=b;$('#brand').textContent=b}function setParams(obj){Object.entries(obj).forEach(([k,v])=>{if(v==null||v==='')QS.delete(k);else QS.set(k,v)});history.replaceState(null,'','?'+QS.toString())}
async function load(){setTitle();$('#q').value=SEARCH;$('#per').value=PER;const src=QS.get('src');if(src){try{const r=await fetch(src);const j=await r.json();applyData(j);if(ALL.length)return}catch{}}try{const la=JSON.parse(localStorage.getItem('adm_articulos')||'[]');applyData({articulos:la});if(ALL.length)return}catch{}try{const r=await fetch('catalogo.json');if(r.ok){const j=await r.json();applyData(j);if(ALL.length)return}}catch{}if(!ALL.length){$('#empty').style.display='block'}buildUI()}
function normArt(a){const imgs=Array.isArray(a.imagenes)?a.imagenes:(a.imagen?[{src:a.imagen,type:'url',primary:true}]:[]);const img=imgs.find(i=>i.primary)||imgs[0]||null;return{id:a.id||a.sku||a.slug||crypto.randomUUID(),nombre:a.nombre||'',categoria:a.categoria||'',precio_venta:+(+a.precio_venta||0).toFixed(2),precio_oferta:a.precio_oferta!=null?+(+a.precio_oferta).toFixed(2):null,stock_actual:Math.max(0,parseInt(a.stock_actual||0)),descripcion_corta:a.descripcion_corta||a.descripcion||'',slug:a.slug||slugify(a.nombre||''),imagenes:imgs,imagen_principal:img?img.src:PLACE,activo:a.activo!==false,creado_en:a.creado_en||a.fecha_creacion||new Date().toISOString(),destacado:a.destacado===true||a.tags?.includes?.('destacado')||false}}
function applyData(j){let arr=[];if(Array.isArray(j))arr=j;else if(j.articulos)arr=j.articulos;else if(j.items)arr=j.items;ALL=arr.map(normArt).filter(a=>a.activo);IDX.byId.clear();IDX.byCat.clear();ALL.forEach(a=>{IDX.byId.set(a.id,a);const c=a.categoria||'Sin categoría';if(!IDX.byCat.has(c))IDX.byCat.set(c,[]);IDX.byCat.get(c).push(a)})}
function slugify(s){return(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')}
function buildUI(){buildQuickCats();$('#import').onclick=()=>$('#fileInput').click();$('#fileInput').onchange=onImportFile;$('#btnDemo').onclick=loadDemo;$('#btnImport2').onclick=()=>$('#fileInput').click();$('#share').onclick=()=>shareLink('');$('#cartBtn').onclick=openCart;$('#cartClose').onclick=closeCart;$('#clearCart').onclick=()=>{CART=[];cartSave();renderCart()};$('#shipSel').onchange=()=>{SHIPID=$('#shipSel').value;localStorage.setItem('pub_ship',SHIPID);renderCart()};$('#waPhone').oninput=e=>{WAPHONE=e.target.value.replace(/\D/g,'');localStorage.setItem('wa_phone',WAPHONE)};$('#checkoutBtn').onclick=checkoutWA;$('#q').oninput=e=>{SEARCH=e.target.value;PAGE=1;setParams({q:SEARCH,page:1});render()};$('#orden').onchange=()=>{PAGE=1;render()};$('#per').onchange=()=>{PER=+$('#per').value;PAGE=1;setParams({per:PER,page:1});render()};$('#clear').onclick=()=>{SEARCH='';CAT='';PAGE=1;setParams({q:'',cat:'',page:1});$('#q').value='';$('#catQuick').value='';render()};window.addEventListener('storage',e=>{if(e.key==='adm_articulos'){try{const la=JSON.parse(e.newValue||'[]');applyData({articulos:la});buildQuickCats();render();toast('Catálogo actualizado')}catch{}}});cartLoad();render()}
function buildQuickCats(){const sel=$('#catQuick');sel.innerHTML='<option value="">Todas</option>'+[...IDX.byCat.keys()].sort().map(c=>`<option>${c}</option>`).join('');sel.value=CAT;sel.onchange=()=>{CAT=sel.value;setParams({cat:CAT,page:1});PAGE=1;render()}}
function applyFilters(){const q=SEARCH.toLowerCase().trim();const s=$('#orden').value;let arr=ALL.slice();if(q)arr=arr.filter(a=>a.nombre.toLowerCase().includes(q)||a.descripcion_corta.toLowerCase().includes(q)||a.categoria.toLowerCase().includes(q));if(CAT)arr=arr.filter(a=>(a.categoria||'Sin categoría')===CAT);if(s==='pa')arr.sort((a,b)=>a.precio_venta-b.precio_venta);if(s==='pd')arr.sort((a,b)=>b.precio_venta-a.precio_venta);if(s==='fd')arr.sort((a,b)=>new Date(b.creado_en)-new Date(a.creado_en));if(s==='rel'&&q)arr.sort((a,b)=>score(b,q)-score(a,q));return arr}
function score(a,q){let s=0;const n=a.nombre.toLowerCase();const d=a.descripcion_corta.toLowerCase();const c=a.categoria.toLowerCase();if(n.startsWith(q))s+=3;if(n.includes(q))s+=2;if(d.includes(q))s+=1;if(c.includes(q))s+=.5;return s}
function render(){const arr=applyFilters();document.getElementById('count').textContent=`${arr.length}/${ALL.length}`;const pages=Math.max(1,Math.ceil(arr.length/PER));const start=(PAGE-1)*PER;renderGrid(arr.slice(start,start+PER));document.getElementById('prev').disabled=PAGE<=1;document.getElementById('next').disabled=PAGE>=pages;document.getElementById('pginfo').textContent=`${PAGE}/${pages}`;document.getElementById('prev').onclick=()=>{if(PAGE>1){PAGE--;setParams({page:PAGE});render();window.scrollTo({top:0,behavior:'smooth'})}};document.getElementById('next').onclick=()=>{if(PAGE<pages){PAGE++;setParams({page:PAGE});render();window.scrollTo({top:0,behavior:'smooth'})}};document.getElementById('empty').style.display=arr.length?'none':'block'}
function cardEl(a){const el=document.createElement('card');el.dataset.id=a.id;const imgBox=document.createElement('div');imgBox.className='img';const im=document.createElement('img');im.loading='lazy';im.decoding='async';im.src=a.imagen_principal||PLACE;im.alt=a.nombre;im.onerror=()=>im.src=PLACE;imgBox.append(im);const name=document.createElement('div');name.className='name';name.textContent=a.nombre;const cat=document.createElement('div');cat.className='cat';cat.textContent=a.categoria;const row=document.createElement('div');row.className='row';const price=document.createElement('div');price.className='price';const p=a.precio_oferta!=null&&a.precio_oferta>=0;price.textContent=p?money(a.precio_oferta):money(a.precio_venta);const old=document.createElement('div');old.className='old';if(p)old.textContent=money(a.precio_venta);row.append(price,old);const actions=document.createElement('div');actions.className='actions';const bBuy=document.createElement('button');bBuy.className='btn';bBuy.textContent='Comprar ahora';bBuy.onclick=(ev)=>{ev.stopPropagation();addToCart(a,1);openCart()};const bAdd=document.createElement('button');bAdd.className='btn ghost';bAdd.textContent='Agregar';bAdd.onclick=(ev)=>{ev.stopPropagation();addToCart(a,1)};actions.append(bBuy,bAdd);const badge=document.createElement('div');badge.className='badge';badge.textContent=a.stock_actual>0?(a.stock_actual<=5?`Quedan ${a.stock_actual}`:'En stock'):'Agotado';el.append(imgBox,name,cat,row,actions,badge);el.onclick=()=>openModal(a);return el}
function renderGrid(items){const g=document.getElementById('grid');g.innerHTML='';items.forEach(a=>g.append(cardEl(a)))}
function openModal(a){if(!a)return;document.getElementById('modal').style.display='grid';document.getElementById('mtitle').textContent=a.nombre;document.getElementById('mdesc').textContent=a.descripcion_corta||'';document.getElementById('minfo').innerHTML='';addInfo('Categoría',a.categoria);addInfo('Precio',money(a.precio_venta));if(a.precio_oferta!=null)addInfo('Oferta',money(a.precio_oferta));addInfo('Stock',a.stock_actual);addInfo('Creación',fmtDate(a.creado_en));document.getElementById('mprice').textContent=a.precio_oferta!=null?money(a.precio_oferta):money(a.precio_venta);const badges=document.getElementById('mbadges');badges.innerHTML='';if(a.stock_actual<=5)badges.append(tag('Últimas unidades'));if(a.precio_oferta!=null)badges.append(tag('Oferta'));const gal=a.imagenes&&a.imagenes.length?a.imagenes:[{src:a.imagen_principal||PLACE}];const main=document.getElementById('mainImg');main.src=gal[0].src||PLACE;main.alt=a.nombre;main.onerror=()=>main.src=PLACE;document.getElementById('thumbs').innerHTML='';gal.forEach((im,i)=>{const t=document.createElement('img');t.src=im.src;t.alt=a.nombre+' '+(i+1);t.loading='lazy';t.decoding='async';t.onerror=()=>t.src=PLACE;t.onclick=()=>{main.src=im.src};document.getElementById('thumbs').append(t)});document.getElementById('mclose').onclick=closeModal;document.getElementById('modal').onclick=e=>{if(e.target.id==='modal')closeModal()};document.getElementById('shareItem').onclick=()=>shareLink('#'+a.slug);document.getElementById('addFromModal').onclick=()=>{addToCart(a,1);openCart()}}
function addInfo(k,v){const d=document.createElement('div');d.textContent=k+': '+v;document.getElementById('minfo').append(d)}
function tag(t){const s=document.createElement('span');s.style.cssText='background:#eef1f7;border:1px solid #dfe3ef;border-radius:999px;padding:4px 8px;font-size:12px';s.textContent=t;return s}
function closeModal(){document.getElementById('modal').style.display='none'}
function shareLink(hash){const url=location.origin+location.pathname+'?'+QS.toString()+hash;if(navigator.share){navigator.share({title:document.title,text:'Tienda',url}).catch(()=>copy(url))}else copy(url)}
function copy(t){navigator.clipboard.writeText(t).then(()=>toast('Enlace copiado'))}
function toast(t){const el=document.createElement('div');el.textContent=t;el.style.cssText='position:fixed;right:14px;bottom:14px;background:#101114;color:#fff;border-radius:12px;padding:10px 12px;z-index:80';document.body.append(el);setTimeout(()=>{el.style.opacity=.0;setTimeout(()=>el.remove(),230)},1200)}
function cartLoad(){try{CART=JSON.parse(localStorage.getItem('pub_cart')||'[]')||[]}catch{CART=[]}cartPrune();updateCartCount();renderCart(false)}function cartSave(){localStorage.setItem('pub_cart',JSON.stringify(CART));updateCartCount()}function cartPrune(){CART=CART.filter(it=>IDX.byId.has(it.id))}function updateCartCount(){const n=CART.reduce((s,it)=>s+it.qty,0);document.getElementById('cartCount').textContent=n}function addToCart(a,qty){qty=Math.max(1,parseInt(qty||1));const i=CART.findIndex(it=>it.id===a.id);if(i>=0)CART[i].qty=Math.min(999,CART[i].qty+qty);else CART.push({id:a.id,qty});cartSave();toast('Agregado al carrito')}function removeFromCart(id){CART=CART.filter(it=>it.id!==id);cartSave();renderCart()}function setQty(id,qty){qty=Math.max(1,Math.min(999,parseInt(qty||1)));const it=CART.find(it=>it.id===id);if(it){it.qty=qty;cartSave();renderCart(false)}}function getPrice(a){return(a.precio_oferta!=null&&a.precio_oferta>=0)?a.precio_oferta:a.precio_venta}function cartSubtotal(){return CART.reduce((s,it)=>{const a=IDX.byId.get(it.id);return s+(getPrice(a)*it.qty)},0)}function shipOptions(){const sel=document.getElementById('shipSel');sel.innerHTML='';SHIP.forEach(o=>{const op=document.createElement('option');op.value=o.id;op.textContent=`${o.name} (${o.price?money(o.price):'Gratis'})`;sel.append(op)});sel.value=SHIPID}function shipCost(sub){if(FREE>0&&sub>=FREE)return 0;const opt=SHIP.find(s=>s.id===SHIPID)||SHIP[0];return opt.price||0}function openCart(){shipOptions();document.getElementById('waPhone').value=WAPHONE||'';renderCart();document.getElementById('cart').style.display='flex'}function closeCart(){document.getElementById('cart').style.display='none'}function renderCart(scrollTop=true){cartPrune();const box=document.getElementById('cartItems');box.innerHTML='';if(!CART.length){box.innerHTML='<div style="opacity:.7">El carrito está vacío</div>'}CART.forEach(it=>{const a=IDX.byId.get(it.id);if(!a)return;const row=document.createElement('div');row.className='cart-row';const img=document.createElement('img');img.src=a.imagen_principal||PLACE;img.alt=a.nombre;img.onerror=()=>img.src=PLACE;const meta=document.createElement('div');meta.className='meta';const nm=document.createElement('div');nm.style.fontWeight='700';nm.textContent=a.nombre;const pr=document.createElement('div');pr.textContent=money(getPrice(a));meta.append(nm,pr);const qty=document.createElement('div');qty.className='qty';const minus=document.createElement('button');minus.className='btn ghost';minus.textContent='–';minus.onclick=()=>{setQty(a.id,Math.max(1,(it.qty-1)))};const inp=document.createElement('input');inp.className='input';inp.type='number';inp.min='1';inp.max='999';inp.value=it.qty;inp.style.width='70px';inp.onchange=e=>setQty(a.id,e.target.value);const plus=document.createElement('button');plus.className='btn ghost';plus.textContent='+';plus.onclick=()=>{setQty(a.id,Math.min(999,(it.qty+1)))};const rm=document.createElement('button');rm.className='btn';rm.textContent='Eliminar';rm.onclick=()=>removeFromCart(a.id);qty.append(minus,inp,plus,rm);row.append(img,meta,qty);box.append(row)});const sub=cartSubtotal();const ship=shipCost(sub);const tot=sub+ship;document.getElementById('cartSubtotal').textContent=money(sub);document.getElementById('cartShipping').textContent=(FREE>0&&sub>=FREE)?`Gratis (≥ ${money(FREE)})`:money(ship);document.getElementById('cartTotal').textContent=money(tot);if(scrollTop)document.getElementById('cartItems').scrollTop=0}
function checkoutWA(){if(!CART.length){toast('Carrito vacío');return}if(!WAPHONE){toast('Configura el WhatsApp destino');document.getElementById('waPhone').focus();return}const items=CART.map(it=>{const a=IDX.byId.get(it.id);return`• ${it.qty}x ${a.nombre} – ${money(getPrice(a))}`}).join('\n');const sub=cartSubtotal();const ship=shipCost(sub);const tot=sub+ship;const brand=document.getElementById('brand').textContent||'Tienda';const sh=SHIP.find(s=>s.id===SHIPID)||SHIP[0];const text=encodeURIComponent(`${brand} – Pedido online\n${items}\nSubtotal: ${money(sub)}\nEnvío (${sh.name}): ${money(ship)}\nTotal: ${money(tot)}\n\nNombre: \nDirección: `);const url=`https://wa.me/${WAPHONE}?text=${text}`;window.open(url,'_blank')}
async function onImportFile(e){const f=e.target.files[0];if(!f)return;const txt=await f.text();try{if(f.name.endsWith('.json')||f.type.includes('json')){const j=JSON.parse(txt);const arts=Array.isArray(j)?j:(j.articulos||j.items||j);localStorage.setItem('adm_articulos',JSON.stringify(arts));applyData({articulos:arts});buildQuickCats();render();toast('Datos importados');return}const rows=parseCSV(txt);if(!rows.length){toast('CSV vacío');return}const head=rows[0].map(h=>h.trim().toLowerCase());const idx=(name)=>head.indexOf(name);const mapped=rows.slice(1).filter(r=>r.length>1).map(r=>({id:r[idx('id')]||'',nombre:r[idx('nombre')]||'',categoria:r[idx('categoria')]||'',precio_venta:+(r[idx('precio')]||r[idx('precio_venta')]||0),precio_oferta:r[idx('precio_oferta')]?+(r[idx('precio_oferta')]):null,stock_actual:+(r[idx('stock')]||r[idx('stock_actual')]||0),slug:r[idx('slug')]||'',activo:(r[idx('activo')]??'1')!='0',imagen:r[idx('imagen')]||'',descripcion_corta:r[idx('descripcion')]||r[idx('descripcion_corta')]||'',creado_en:r[idx('creado_en')]||''}));localStorage.setItem('adm_articulos',JSON.stringify(mapped));applyData({articulos:mapped});buildQuickCats();render();toast('CSV importado')}catch(err){toast('Error al importar')}e.target.value=''}
function parseCSV(txt){const out=[];let row=[];let cur='';let q=false;for(let i=0;i<txt.length;i++){const c=txt[i];if(q){if(c==='"'){if(txt[i+1]==='"'){cur+='"';i++}else{q=false}}else{cur+=c}}else{if(c==='"'){q=true}else if(c===','){row.push(cur);cur=''}else if(c==='\n'||c==='\r'){if(c==='\r'&&txt[i+1]==='\n'){i++}row.push(cur);out.push(row);row=[];cur=''}else{cur+=c}}}if(cur.length||row.length){row.push(cur);out.push(row)}return out}
function loadDemo(){const demo=[1,2,3,4,5,6,7,8,9,10,11,12].map(i=>({id:'demo-'+i,nombre:'Producto '+i,categoria:['Accesorios','Hogar','Electrónica','Ropa'][i%4],precio_venta:10000+i*500,precio_oferta:i%3===0?(8000+i*400):null,stock_actual:(i%5===0?0:(i%4===0?2:10+i)),descripcion_corta:'Descripción breve '+i,imagen:`https://picsum.photos/seed/${i}/600/600`,activo:true,creado_en:new Date(Date.now()-i*86400000).toISOString(),destacado:i%4===0}));localStorage.setItem('adm_articulos',JSON.stringify(demo));applyData({articulos:demo});buildQuickCats();render();toast('Demo cargada')}
window.addEventListener('resize',()=>{const arr=applyFilters();document.getElementById('grid').style.setProperty('--items',arr.length)});
function toastOnce(){let t;return s=>{clearTimeout(t);t=setTimeout(()=>toast(s),0)}}const toast1=toastOnce();
function init(){load();setTitle()}
init();
</script>
</body>
</html>
